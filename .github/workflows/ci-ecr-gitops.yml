name: CI — Build & Push to ECR + Update GitOps

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: proj8-eks-app        # <--- adjust repository name if needed
  IMAGE_PORT: 5000

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr_login
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push image
        id: build_and_push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: |
            ${{ steps.ecr_login.outputs.registry }}/${{ env.IMAGE_NAME }}:latest
            ${{ steps.ecr_login.outputs.registry }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set IMAGE_URI output
        run: echo "IMAGE_URI=${{ steps.ecr_login.outputs.registry }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_ENV

  update-gitops:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()
    steps:
      - name: Checkout repo (for small helper)
        uses: actions/checkout@v4

      - name: Install git (if not present) and jq, yq
        run: |
          sudo apt-get update && sudo apt-get install -y git jq
          # yq used for YAML editing (optional); using python/sed here to keep simple
      - name: Clone gitops repo
        env:
          GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
          GITOPS_BRANCH: main
        run: |
          # clone the target repo using token
          git clone https://x-access-token:${{ secrets.GITOPS_REPO_TOKEN }}@github.com/${GITOPS_REPO}.git /tmp/gitops
          cd /tmp/gitops
          git checkout $GITOPS_BRANCH || true
          echo "Cloned gitops repo root: $(pwd)"
      - name: Update image reference in gitops manifests
        env:
          IMAGE_URI: ${{ env.IMAGE_URI }}
        run: |
          cd /tmp/gitops
          # sample: update image in deployment manifest under flask-app/deployment.yaml
          # this will replace the image line. Adjust path/pattern as per your manifest.
          FILE=flask-app/deployment.yaml
          if [ -f "$FILE" ]; then
            echo "Updating $FILE -> image: $IMAGE_URI"
            # naive sed replace - replace the image: line
            # handles patterns like: image: something:tag
            sed -i -E "s|image: .*|image: ${IMAGE_URI}|g" "$FILE"
            git add "$FILE"
            git commit -m "ci: bump image to ${IMAGE_URI}" || echo "no changes to commit"
          else
            echo "$FILE not found — please update this workflow to match your manifest path"
          fi

      - name: Push gitops update
        run: |
          cd /tmp/gitops
          git config user.email "${{ secrets.GIT_USER_EMAIL }}"
          git config user.name "${{ secrets.GIT_USER_NAME }}"
          git push origin HEAD:${{ secrets.GITOPS_BRANCH }}

      - name: (optional) Trigger ArgoCD sync via API
        if: ${{ secrets.ARGOCD_SERVER && secrets.ARGOCD_TOKEN }}
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN: ${{ secrets.ARGOCD_TOKEN }}
        run: |
          # Trigger ArgoCD application sync (app name = flask-app)
          curl -k -s -X POST -H "Authorization: Bearer ${ARGOCD_TOKEN}" \
            "${ARGOCD_SERVER}/api/v1/applications/flask-app/sync" | jq .
